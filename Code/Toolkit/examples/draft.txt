INCLUDE res/source1.exa ! defines Source1 
INCLUDE res/source2.exa ! defines Source2 .
INCLUDE ref_crit_1.exa  ! ...
INCLUDE ref_crit_2.exa
INCLUDE geometry_1.exa
INCLUDE geometry_2.exa

module ForwardModeling
  domain Cube
    dimension 3
    widths    0.3, 0.3, 0.3
    offsets   0.1, 0.2, 0.1
  end domain    
      
  solver Pde11
    number_of_variables  4
    polynomial_order     5
    maximal_mesh_size    0.004
    
    variable Velocity
      indices 0,1,2
      id      'u'
      name    'velocity'
      unit    'METER_PER_SECOND'
    end variable
    
    variable Pressure
      indices 3
      id      'p'
      name    'pressure'
      unit    'NEWTON'
    end variable
    
    volume_kernel          ...,...,...
    self_flux_kernel       ...,...,... 
    neighbor_flux_kernel   ...,...,...
    
    domain                 Cube
    refinement_criteria    RefCrit1,...
    source                 Source1,...
    initial_condition      InitCond1,...
    geometry               Geometry1,...
  end solver  
  
  solver Pde12  
    number_of_variables  4
    polynomial_order     5
    maximal_mesh_size    0.008
    
    variable Velocity
      indices 0,1,2
      id      'u'
      name    'velocity'
      unit    'METER_PER_SECOND'
    end variable
    
    variable Pressure
      indices 3
      id      'p'
      name    'pressure'
      unit    'NEWTON'
    end variable
    
    volume_kernel        ...,...,...
    self_flux_kernel     ...,...,... 
    neighbor_flux_kernel ...,...,...
    
    domain               Cube
    refinement_criteria  RefCrit1,...
    source               Source1,...
    initial_condition    InitCond1,...
    geometry             Geometry1,... ! Need to define which material parameters exist etc.
  end solver
  
  solver Pde2  ! e.g., low order shot to find principal path of wave 
    number_of_variables  4
    polynomial_order     1
    maximal_mesh_size    0.04
    
    variable Velocity
      indices 0,1,2
      id      'u'
      name    'velocity'
      unit    'METER_PER_SECOND'
    end variable
    
    variable Pressure
      indices 3
      id      'p'
      name    'pressure'
      unit    'NEWTON'
    end variable
    
    volume_kernel        ...,...,...
    self_flux_kernel     ...,...,... 
    neighbor_flux_kernel ...,...,...
    
    domain               Cube
    refinement_criteria  none
    source               Source1,...
    initial_condition    InitCond1,...
    geometry             Geometry1,...
  end solver
  
  ! Definition far from final
  local_functional LocalL2Error 
    variable       l2_error ! This variable is stored within the cell
    solvers        Pde11,Pde12
    expression     sqrt(vol_int((Pde11.dof - Pde12.dof)' * (Pde11.dof-Pde12.dof))   
  end local_functional
  
  ! Definition far from final
  global_functional L2Error 
    solvers         Pde11,Pde12 
    variable        l2_error ! This variable is stored within the state
    expression      sqrt(global_sum(vol_int((LSWE1.dof - LSWE2.dof)' * (LSWE1.dof-LSW2.dof)))   
  end global_functional
  
  ! Definition far from final
  schedule Main
    start_time     10
    stop_time      10000
  
    task UpdatePdes ! Should be mapped to adapters+mappings
      start    0
      stride   1
      run      Pde11,Pde12,Pde2
      evaluate none                      
    end task
    
    task EvaluateL2Error 
      start    10
      stride   100
      run      none
      evaluate LocalL2Error,L2Error
    end task
    
    task Visualize 
      start    10
      stride   1000
      run      none
      ...
    end task
  end schedule
end module
